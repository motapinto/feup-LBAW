"use strict";const addEventListeners=()=>{const e=document.querySelector('meta[name="csrf-token"]').getAttribute("content"),t=document.querySelector("button#offer-submit"),n=document.querySelector("section#discount-input button.btn-blue"),d=document.getElementById("product-selection"),r=document.querySelector("img.productPageImgPreview"),a=document.querySelector("section#key-input button.btn-blue"),s=()=>{const e=new FormData(document.querySelector("form#content")),n=document.getElementById("offer-submit-error"),r=document.getElementById("offer-submit");if(""===d.value)return n.innerText="Please select a product and platform.",d.classList.add("border-danger"),r.classList.add("border-danger"),void n.classList.add("d-block");d.classList.remove("border-danger");const a=e.getAll("key[]");if(0===a.length)return n.innerText="There must be at least one key.",r.classList.add("border-danger"),void n.classList.add("d-block");for(let e=0;e<a.length;e++){const t=a[e];if(!l(t.value))return n.innerText="There is an invalid key.",r.classList.add("border-danger"),void n.classList.add("d-block")}const o=e.getAll("discount[][start]"),i=e.getAll("discount[][end]"),u=e.getAll("discount[][rate]");if(o.length!==i.length||o.length!==u.length)return n.innerText="There is an invalid discount row.",r.classList.add("border-danger"),void n.classList.add("d-block");for(let e=0;e<o.length;e++)if(!c(o[e])||!c(i[e])||u[e]<1||u[e]>99)return n.innerText="There is an invalid discount row.",r.classList.add("border-danger"),void n.classList.add("d-block");const m=e.get("price");(null===m||m<1)&&(n.innerText="Please fill the price per key with a valid value.",r.classList.add("border-danger"),n.classList.add("d-block")),n.innerText="",r.classList.remove("border-danger"),n.classList.remove("d-block");let b=[];for(let e=0;e<o.length;e++)b.push({start:o[e],end:i[e],rate:u[e]});const g=document.getElementById("platform-selection"),p=e.get("paypal");let y={product:d.value,platform:g.value,keys:a,discounts:b,price:m,paypal:p};t.removeEventListener("click",s),v(y).then(e=>{let d=e.status;e.text().then(e=>{200===d?window.location=e:n.innerText=e,t.addEventListener("click",s)})}).catch(e=>{n.innerText=`${e}`,r.classList.add("border-danger"),n.classList.add("d-block"),t.addEventListener("click",s)})},l=e=>/^\w+([\-|\\|\/]\w+)*$/g.test(e),o=()=>{document.querySelectorAll("#key-input-added button").forEach(e=>{e.addEventListener("click",()=>{e.parentElement.parentElement.remove()})})},i=e=>{let t=e.getFullYear(),n=e.getMonth()+1,d=e.getDate();return n<10&&(n="0"+n),d<10&&(d="0"+d),[t,n,d].join("-")},c=e=>/^\d{4}[\/\-](0?[1-9]|1[012])[\/\-](0?[1-9]|[12][0-9]|3[01])$/.test(e),u=e=>{const t=document.getElementById("discount-input-error"),n=e[0],d=e[1],r=e[2];return t.innerText=null,t.classList.remove("d-block"),n.classList.remove("border-danger"),d.classList.remove("border-danger"),r.classList.remove("border-danger"),null==n.value?(t.innerText="The start date must not be empty.",n.classList.add("border-danger"),t.classList.add("d-block"),!1):null==d.value?(t.innerText="The end date must not be empty.",n.classList.add("border-danger"),t.classList.add("d-block"),!1):null==r.value?(t.innerText="The discount rate must not be empty.",r.classList.add("border-danger"),t.classList.add("d-block"),!1):c(n.value)?c(d.value)?r.value<1||r.value>99?(t.innerText="The discount rate must be between 1% and 99%.",r.classList.add("border-danger"),t.classList.add("d-block"),!1):!(new Date(d.value)<=new Date(n.value))||(t.innerText="The end date must be at least one day after the start date.",n.classList.add("border-danger"),d.classList.add("border-danger"),t.classList.add("d-block"),!1):(t.innerText="The end date must be in the correct format and be valid.",d.classList.add("border-danger"),t.classList.add("d-block"),!1):(t.innerText="The start date must be in the correct format and be valid.",n.classList.add("border-danger"),t.classList.add("d-block"),!1)},m=()=>{document.querySelectorAll("#discount-input tbody button").forEach(e=>{e.addEventListener("click",()=>{e.parentElement.parentElement.remove(),b()})})},b=()=>{const e=document.querySelectorAll("#discount-input tbody th");for(let t=0;t<e.length-1;t++)e[t].innerHTML=String(t+1)},v=t=>{const n={headers:{"Content-Type":"application/json",Accept:"application/json, text-plain, */*","X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":e},method:"put",credentials:"same-origin",body:JSON.stringify(t)};return fetch("/offer/",n)};d.addEventListener("change",()=>{let e=d.options[d.selectedIndex];r.src=e.getAttribute("data-img"),(e=>{if(null==e||!Array.isArray(e))return;const t=document.getElementById("platform-selection");for(let e=t.length-1;e>=0;e--)t.remove(e);for(let n=0;n<e.length;n++){let d=e[n],r=document.createElement("option");r.value=d.id,r.text=d.name,t.add(r)}})(JSON.parse(e.getAttribute("data-platforms")))}),a.addEventListener("click",()=>{let e=document.getElementById("key-input-add"),t=document.getElementById("key-input-error");if(null==e.value||0===e.value.length)return t.innerText="The key must not be empty.",e.classList.add("border-danger"),void t.classList.add("d-block");if(!l(e.value))return t.innerText="The key inserted must have only letters and numbers and can be divided with - or \\ or /.",e.classList.add("border-danger"),void t.classList.add("d-block");t.innerText=null,e.classList.remove("border-danger"),t.classList.remove("d-block");let n=(e=>`\n        <div class="input-group mt-2">\n            <input type="text" name="key[]" class="form-control mr-2" readonly value="${e}">\n            <span class="input-group-btn">\n                <button type="button" class="btn btn-red"><i class="fas fa-times-circle"></i></button>\n            </span>\n        </div>\n    `)(e.value),d=document.getElementById("key-input-added");e.value=null,d.innerHTML+=n,o()}),n.addEventListener("click",()=>{let e=document.querySelector("#discount-input tbody"),t=document.querySelectorAll("#discount-input-add input"),n=document.getElementById("discount-input-add");if(!u(t))return;let d=((e,t,n,d)=>{let r=document.createElement("tr");return r.innerHTML=`    \n            <th scope="row">${e}</th>\n            <td><input type="date" name="discount[][start]" class="mx-auto form-control" value="${t}" readonly></td>\n            <td><input type="date" name="discount[][end]" class="mx-auto form-control" value="${n}" readonly></td>\n            <td class="w-25"><input type="number" name="discount[][rate]" class="mx-auto form-control" value="${d}" readonly></td>\n            <td><button class="btn btn-red ml-2"><i class="fas fa-times-circle mt-auto mb-auto d-inline-block"></i></button></td>\n        `,r})(e.children.length,t[0].value,t[1].value,t[2].value),r=new Date,a=new Date(r);a.setDate(a.getDate()+1),t[0].setAttribute("value",i(r)),t[1].setAttribute("value",i(a)),t[2].value=1,e.insertBefore(d,n),m()}),t.addEventListener("click",s)};addEventListeners();